
■ELBとは
AWSが提供するマネージドロードバランサーサービス
 
 
■ロードバランサ—
クライアントからの受信トラフィックを受け入れ、リクエストを 1 つ以上のAZにある登録済みのターゲット(EC2インスタンス等)にルーティングする
登録されているターゲットの状態を監視して、トラフィックが正常なターゲットにのみルーティングされるようにする
異常なターゲットを検出すると、そのターゲットへのトラフィックのルーティングを中止する
その後、ターゲットが再び正常になったことを検出すると、そのターゲットへのトラフィックのルーティングを再開する
 
 
■ALBとは
様々なプロトコルをサポートする、高度なロードバランシングサービス
アプリケーショントラフィックを複数のターゲットに分散させ、アプリケーションの可用性とスケーラビリティを向上させる役割を持つ
 
1.クライアントがALBのドメインまたはIPアドレスにリクエストを送信する
2.ALBのリスナーがリクエストを受信、ポート番号・プロトコル・SSL/TLS設定などに基づいてリクエストを処理するロードバランサ—を決定する
3.ロードバランサ—はリクエストを処理するターゲットグループを選択する
4.ロードバランサ—は選択されたターゲットにリクエストを転送する
5.ターゲットはリクエストを処理し、レスポンスをALBに返す
6.ALBはレスポンスをクライアントに返す
 
*リスナー
ALBに最初にアクセスするクライアントからのリクエストを受け取る
リクエストを処理するロードバランサ—を決定する
*ロードバランサ—
ターゲットグループにリクエストを転送する
ラウンドロビン等のアルゴリズムを使用してターゲットグループ内のターゲットにリクエストを分散させる
*ターゲットグループ
ALBに登録されている一連のターゲット(EC2インスタンス,Lambda関数,コンテナ等)で構成される
ヘルスチェックを使用して、ターゲットの健全性を監視可能
*ターゲット
ALBに登録されている実際のアプリケーションサーバー(EC2インスタンス,Lambda関数,コンテナ等)
 
 
■ターゲットグループ名
最大32文字の英数字またはハイフンのみを使用する必要有、先頭と末尾へのハイフンは使用不可
 
■スキーム
ロードバランサーを内部向けにするかインターネット向けにするか選択する必要有
インターネット向けロードバランサーのノードにはパブリック IP アドレスが必要
内部ロードバランサーのノードはプライベート IP アドレスのみを持つ
インターネット向けロードバランサーと内部向けロードバランサーは、どちらもプライベート IP アドレスを使用してリクエストをターゲットにルーティングする
→ターゲットは、内部またはインターネット向けロードバランサーからリクエストを受信するためのパブリック IP アドレスを必要としない
 
 
■スティッキーセッション
ロードバランサ—が同じクライアントからのリクエストを常に同じターゲットに転送するように設定する機能
セッションデータや接続状態を維持することが可能
*セッション保持時間：クライアントが最後にアクティブだった後、セッションが保持される時間
*アプリケーション管理型スティッキーセッション：アプリケーションがセッションデータをcookie等の手段で管理する
*ロードバランサ—管理型スティッキーセッション：ロードバランサ—がセッションデータをcookie等の手段で管理する
*クロスゾーン負荷分散が無効の場合、スティッキーセッション有効化ができない
 
 
■クロスゾーン負荷分散
各AZのロードバランサ—ノードがそれぞれ有効なすべてのアベイラビリティーゾーンの登録済みターゲットにトラフィックを分散させることを可能にする機能
https://docs.aws.amazon.com/ja_jp/elasticloadbalancing/latest/userguide/how-elastic-load-balancing-works.html
ALBではロードバランサーレベルで常に有効、ターゲットグループでは無効化可能
NLBではデフォルトで無効だが、作成後でも有効化や無効化が可能
 
 
■ヘルスチェックの仕組み
ALBはヘルスチェックの仕組みに基づいて、定期的にターゲットに対してヘルスチェックリクエストを送信する
これにより、ターゲットが正常に応答しているかを確認する
ターゲットが正常に応答した場合、ALBはそのターゲットを正常な状態としてマークする
ターゲットが応答しないか、タイムアウトした場合、またはエラー応答を返した場合、ALBはそのターゲットを異常な状態としてマークする
 
→ALBは異常な状態にあるターゲットへのリクエストを転送せず、正常な状態にあるターゲットにのみリクエストを送信する
ヘルスチェックパスはサーバの特定のパスというより、ウェブアプリケーション内の特定のエンドポイント(通常はWebページ)に対するリクエストパスを指す
↑httpd.conf等で定義されていることが多い
ヘルスチェックで「/」が選択された場合、通常はサイトのトップページやデフォルトページに対するリクエストとして扱われる
 
 
■タグ
リソースあたりのタグの最大数 – 50
キーの最大長 – 127 文字 (Unicode)
値の最大長 – 255 文字 (Unicode)
タグのキーと値は大文字と小文字が区別される
使用できる文字は、UTF-8 で表現できる文字、スペース、および数字と、特殊文字 (+、-、=、.、_、:、/、@) ※先頭または末尾にはスペースを使用してはダメ
タグの名前または値に aws: プレフィックスは使用ダメ(このプレフィックスは AWS 用に予約されてる) このプレフィックスが含まれるタグの名前または値は編集または削除不可、このプレフィックスを持つタグは、リソースあたりのタグ数の制限時には計算されない
 
 
■ターゲットステータス
initial：ターゲットを登録中 or ターゲットで最初のヘルスチェックを実行中
healthy：ターゲットは正常
unhealthy：ターゲットがヘルスチェックに応答しなかった or ヘルスチェックに失敗 or ターゲットが停止状態
draining：ターゲットは登録解除中で、Connection Draining 中
unhealthy.draining：
ターゲットがヘルスチェックに応答しなかったか、ヘルスチェックに合格しなかったため、猶予期間に入る
ターゲットは既存の接続をサポートしており、この猶予期間中は新しい接続を受け入れない
unavailable：ターゲットヘルスが使用不可
unused：ターゲットがターゲットグループに登録されていない or ターゲットグループがリスナールールで使用されていない or ターゲットが有効化されていないアベイラビリティーゾーンにある